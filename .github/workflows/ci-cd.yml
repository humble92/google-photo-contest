name: Flutter CI/CD

env:
  FLUTTER_VERSION: "3.35.5"
  FLUTTER_CHANNEL: "stable"
  
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Job 1: Build and Test
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Common Flutter Setup
        uses: ./.github/actions/common-flutter-setup
        with:
          pub-cache-path: ~/.pub-cache

      - name: Create env file for tests
        run: |
          echo "SUPABASE_URL=https://example.supabase.co" > env
          echo "SUPABASE_ANON_KEY=dummy-key-for-tests" >> env
          echo "GOOGLE_WEB_CLIENT_ID=dummy-client-id" >> env
          echo "GOOGLE_IOS_CLIENT_ID=dummy-ios-client" >> env
          echo "GOOGLE_SERVER_CLIENT_ID=dummy-server-client" >> env

      - name: Analyze code
        run: flutter analyze
      
      - name: Run tests
        run: flutter test

  # Job 2: Build Web
  build-web:
    name: Build Web
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Common Flutter Setup
        uses: ./.github/actions/common-flutter-setup
        with:
          pub-cache-path: ~/.pub-cache
      
      - name: Create env file
        continue-on-error: false
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> env
          echo "GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }}" >> env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> env
          echo "GOOGLE_SERVER_CLIENT_ID=${{ secrets.GOOGLE_SERVER_CLIENT_ID }}" >> env
      
      - name: Build Web
        run: flutter build web --release

      - name: Create .nojekyll file
        run: touch build/web/.nojekyll

      # For safety, comment out the CNAME file creation step
      # - name: Create CNAME file
      #   run: echo "photocontest.ninefruits.work" > build/web/CNAME

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

  # Job 3: Build Android
  build-android:
    name: Build Android
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - name: Run Common Flutter Setup
        uses: ./.github/actions/common-flutter-setup
        with:
          pub-cache-path: ~/.pub-cache
      
      - name: Create env file
        continue-on-error: false
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> env
          echo "GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }}" >> env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> env
          echo "GOOGLE_SERVER_CLIENT_ID=${{ secrets.GOOGLE_SERVER_CLIENT_ID }}" >> env
      
      - name: Decode keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d -i > android/app/upload-keystore.jks
            echo "✅ Keystore decoded."
            ls -lh android/app/upload-keystore.jks
          else
            echo "❌ Error: ANDROID_KEYSTORE_BASE64 secret is missing or empty!"
            exit 1
          fi
      
      - name: Create key.properties
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$ANDROID_KEYSTORE_PASSWORD" ]; then
            cat > android/key.properties <<EOF
          storePassword=$ANDROID_KEYSTORE_PASSWORD
          keyPassword=$ANDROID_KEY_PASSWORD
          keyAlias=$ANDROID_KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
            echo "✅ key.properties created."
          else
            echo "❌ Error: ANDROID_KEYSTORE_PASSWORD secret is missing!"
            exit 1
          fi
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Build App Bundle
        run: flutter build appbundle --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7
      
      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-appbundle
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 7

      - name: Upload Native Debug Symbols
        uses: actions/upload-artifact@v4
        id: native-debug-symbols
        with:
          name: "native-debug-symbols"
          path: build/app/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib/*
          retention-days: 7

      # mapping.txt, usage.txt, resources.txt, etc.
      - name: Upload Mapping File
        uses: actions/upload-artifact@v4
        id: mapping-file
        with:
          name: "android-mapping-files"
          path: build/app/outputs/mapping/release/*
          retention-days: 7

      # - name: Deploy to Play Store
      #   uses: r0adkll/upload-google-play@v1
      #   with:
      #     serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
      #     packageName: work.ninefruits.photocontest.humble_photo_contest
      #     releaseFiles: build/app/outputs/bundle/release/app-release.aab
      #     track: internal

  # Job 4: Build iOS
  build-ios:
    name: Build iOS
    needs: test
    runs-on: macos-latest
    if: false && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Common Flutter Setup
        uses: ./.github/actions/common-flutter-setup
        with:
          pub-cache-path: ~/.pub-cache
          shell: bash

      - name: Create env file
        continue-on-error: false
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" > env
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> env
          echo "GOOGLE_WEB_CLIENT_ID=${{ secrets.GOOGLE_WEB_CLIENT_ID }}" >> env
          echo "GOOGLE_IOS_CLIENT_ID=${{ secrets.GOOGLE_IOS_CLIENT_ID }}" >> env
          echo "GOOGLE_SERVER_CLIENT_ID=${{ secrets.GOOGLE_SERVER_CLIENT_ID }}" >> env
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Build iOS (No Codesign)
        run: flutter build ios --release --no-codesign
      
      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos
          retention-days: 7

  # Optional: Deploy Web to GitHub Pages
  deploy-web:
    name: Deploy Web to GitHub Pages
    needs: build-web
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Download Web Build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-build
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: web-build
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
